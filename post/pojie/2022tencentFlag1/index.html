<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>小白向—2022腾讯游戏安全初赛分析（上） | Zency</title><meta name="author" content="Zency"><meta name="copyright" content="Zency"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考：smallzhong&#x2F;gslab-2022-competition: 2022腾讯游戏安全PC初赛答案 (github.com) 2022腾讯游戏安全大赛复盘 - 吾爱破解 - 52pojie.cn 2022腾讯游戏安全PC端初赛复现 - 吾爱破解 - 52pojie.cn 前言：在爱破网的精华帖里看到了对2022腾讯游戏安全初赛的分析（“参考”中的第二条链接），感觉挺有意思的，但">
<meta property="og:type" content="article">
<meta property="og:title" content="小白向—2022腾讯游戏安全初赛分析（上）">
<meta property="og:url" content="http://example.com/post/pojie/2022tencentFlag1/index.html">
<meta property="og:site_name" content="☀️ SunnyCandy&#39;s blog 🍬">
<meta property="og:description" content="参考：smallzhong&#x2F;gslab-2022-competition: 2022腾讯游戏安全PC初赛答案 (github.com) 2022腾讯游戏安全大赛复盘 - 吾爱破解 - 52pojie.cn 2022腾讯游戏安全PC端初赛复现 - 吾爱破解 - 52pojie.cn 前言：在爱破网的精华帖里看到了对2022腾讯游戏安全初赛的分析（“参考”中的第二条链接），感觉挺有意思的，但">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/4ba515845bfc27a4c7811ededcbf49cd4d372054d1544d00efb3bf9d1c754b95129e7006549fdcd6ba5ef07b3abb2ea4?pictype=scale&from=30013&version=3.3.3.3&fname=20.png&size=750">
<meta property="article:published_time" content="2024-09-28T13:54:51.000Z">
<meta property="article:modified_time" content="2024-10-08T02:50:37.864Z">
<meta property="article:author" content="Zency">
<meta property="article:tag" content="逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/4ba515845bfc27a4c7811ededcbf49cd4d372054d1544d00efb3bf9d1c754b95129e7006549fdcd6ba5ef07b3abb2ea4?pictype=scale&from=30013&version=3.3.3.3&fname=20.png&size=750"><link rel="shortcut icon" href="/asset/img/head.jpg"><link rel="canonical" href="http://example.com/post/pojie/2022tencentFlag1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Zency","link":"链接: ","source":"来源: ☀️ SunnyCandy's blog 🍬","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '小白向—2022腾讯游戏安全初赛分析（上）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-08 10:50:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name=referrer content= no-referrer><link rel="stylesheet" href="/asset/css/custom.css"><link rel="stylesheet" href="/asset/css/comment.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4199517_aslsyrov4hi.css"  media="defer" onload="this.media='all'"><span id="fps"></span><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/xlenco/JS-X@main/pace.js/pace.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/asset/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 🏠首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 📑文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><span> ⏳时间轴</span></a></li><li><a class="site-page child" href="/tags/"><span> 🔖标签</span></a></li><li><a class="site-page child" href="/categories/"><span> 🗂️分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ⚒️工具箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/toolweb/"><span> 🧭网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 🥯社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><span> 🔗友链</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 🍬个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/myvoice/"><span> 💭碎碎念</span></a></li><li><a class="site-page child" href="/about/"><span> ☀️关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="☀️ SunnyCandy's blog 🍬"><span class="site-name">☀️ SunnyCandy's blog 🍬</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 🏠首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 📑文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><span> ⏳时间轴</span></a></li><li><a class="site-page child" href="/tags/"><span> 🔖标签</span></a></li><li><a class="site-page child" href="/categories/"><span> 🗂️分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ⚒️工具箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/toolweb/"><span> 🧭网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 🥯社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><span> 🔗友链</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 🍬个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/myvoice/"><span> 💭碎碎念</span></a></li><li><a class="site-page child" href="/about/"><span> ☀️关于</span></a></li></ul></div></div></div><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></nav><div id="post-info"><h1 class="post-title">小白向—2022腾讯游戏安全初赛分析（上）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-28T13:54:51.000Z" title="发表于 2024-09-28 21:54:51">2024-09-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-08T02:50:37.864Z" title="更新于 2024-10-08 10:50:37">2024-10-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%80%86%E5%90%91/">逆向</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="小白向—2022腾讯游戏安全初赛分析（上）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a target="_blank" rel="noopener" href="https://github.com/smallzhong/gslab-2022-competition?tab=readme-ov-file">smallzhong&#x2F;gslab-2022-competition: 2022腾讯游戏安全PC初赛答案 (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1904205-1-1.html">2022腾讯游戏安全大赛复盘 - 吾爱破解 - 52pojie.cn</a></p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1952072-1-1.html">2022腾讯游戏安全PC端初赛复现 - 吾爱破解 - 52pojie.cn</a></p>
<h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>在爱破网的精华帖里看到了对2022腾讯游戏安全初赛的分析（“参考”中的第二条链接），感觉挺有意思的，但因为当时看的时候楼主是纯小白（甚至没用过ida pro），完全看不懂，就想着去学一学，试一试。学到了很多东西，觉得是一次不错的入门经历，因此记录下来，向其他小白详细地介绍整个分析以及操作的流程。</p>
<h1 id="小白将学到"><a href="#小白将学到" class="headerlink" title="小白将学到"></a>小白将学到</h1><ol>
<li><p>ida pro的基本使用。</p>
</li>
<li><p>hook的概念以及操作方式</p>
</li>
<li><p>dump的概念以及操作方式</p>
</li>
</ol>
<h1 id="所需前置知识"><a href="#所需前置知识" class="headerlink" title="所需前置知识"></a>所需前置知识</h1><p>c语言基础</p>
<h1 id="所需工具"><a href="#所需工具" class="headerlink" title="所需工具"></a>所需工具</h1><p>IDA Pro</p>
<p>Visual Studio</p>
<h1 id="赛题说明"><a href="#赛题说明" class="headerlink" title="赛题说明"></a>赛题说明</h1><p>赛题下载链接：<a target="_blank" rel="noopener" href="https://gslab.qq.com/html/competition/2022/doc/PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8-%E5%88%9D%E8%B5%9B%E8%B5%9B%E9%A2%98.zip">https://gslab.qq.com/html/competition/2022/doc/PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8-%E5%88%9D%E8%B5%9B%E8%B5%9B%E9%A2%98.zip</a></p>
<p>这里有一个画了flag的小程序，可好像出了点问题，flag丢失了，需要把它找回来。<br>题目：</p>
<p><img src="https://i-blog.csdnimg.cn/direct/5579ccc6e6fd4da792d259e328a6afb3.png" alt="请添加图片描述"><br>找回flag样例：</p>
<p><img src="https://i-blog.csdnimg.cn/direct/6d26c5ef5b104fa0a9348ab8dcef9b62.png" alt="请添加图片描述"></p>
<h1 id="操作与分析"><a href="#操作与分析" class="headerlink" title="操作与分析"></a>操作与分析</h1><p>接下来正式开始。</p>
<h2 id="使用IDA-Pro打开赛题的exe程序"><a href="#使用IDA-Pro打开赛题的exe程序" class="headerlink" title="使用IDA Pro打开赛题的exe程序"></a>使用IDA Pro打开赛题的exe程序</h2><p>首先使用ida pro打开赛题的exe程序<br><img src="https://i-blog.csdnimg.cn/direct/b0ad43d2179b471995e13e70f92b6100.png" alt="请添加图片描述"></p>
<p>在弹出的文件选择窗口中选择赛题的exe程序</p>
<p><img src="https://i-blog.csdnimg.cn/direct/f746e510d5b74f7297d977a6e8f3005e.png" alt="请添加图片描述"><br>之后弹出的第一个窗口直接选ok，第二个选择no。</p>
<p><img src="https://i-blog.csdnimg.cn/direct/c5d19c08718c45c7811fed96ea4e4bf7.png" alt="请添加图片描述"><br><img src="https://i-blog.csdnimg.cn/direct/70bee4a4ad014176a5836aef25f83048.png" alt="请添加图片描述"></p>
<p>文件就加载完成了</p>
<p><img src="https://i-blog.csdnimg.cn/direct/5ea0defdbdcb4d22b1700acaf7d59c93.png" alt="请添加图片描述"></p>
<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><p>我们的主界面初始位于IDA View-A窗口，且看到的是一个被称为graphs的界面，按下空格键可在graphs界面与hex代码界面（这只是我的称呼，官方名称我也不太清楚）切换，其中展示的是汇编代码。</p>
<p>IDA的左边具有一个Functions窗口，罗列了系统检索到的函数，其中具有一个名为WinMain函数，类似于C中的main函数，是整个程序的起始函数。双击WinMain，IDA会跳转到WinMain汇编代码的部分。<br><img src="https://i-blog.csdnimg.cn/direct/cac3cded0eaf467385501940ecf1a3cd.png" alt="请添加图片描述"></p>
<p>汇编代码很难分析，我们想要看c语言代码，按下Tab键，将跳转到WinMain函数的c代码界面，即Pseudocode-A界面。<br><img src="https://i-blog.csdnimg.cn/direct/fb4b9f99b019411ea097c8bc35179026.png" alt="请添加图片描述"></p>
<p>现在我们可以开始分析代码的逻辑了。查看WinMain函数中的代码，可以发现在60行以前都是赋值，在第61行开始进行逻辑功能处理<br><img src="https://i-blog.csdnimg.cn/direct/d1cadd8dd8f5406b825d7bd1d1dac0cb.png" alt="请添加图片描述"></p>
<p>粉紫色的函数为windows提供的官方api，且经询问ai得知与图像绘制无关<br><img src="https://i-blog.csdnimg.cn/direct/8f65368971464a1ca8ba49ad3b9b8318.png" alt="请添加图片描述"></p>
<p>因此推测图像处理逻辑存在于else中的sub_140001090函数，双击此函数，进入其函数实现界面，观察代码<br><img src="https://i-blog.csdnimg.cn/direct/5ab14a9c1be54e6888afda0823005595.png" alt="请添加图片描述"></p>
<p>从第18行开始进入逻辑处理，观察代码，每遇到一个深蓝色变量都双击观察其是否具有初始值，如byte_140008314, 双击后显示db 为 “？”, 即没有初始值，不深究<br><img src="https://i-blog.csdnimg.cn/direct/cd575b50481743baae76a90630cd81b9.png" alt="请添加图片描述"></p>
<p>而xmmword_140003490双击后为<br><img src="https://i-blog.csdnimg.cn/direct/206c4c1782644cae8e5423b08dd739cd.png" alt="请添加图片描述"></p>
<p>617574726956657461636F6C6C41775Ah，尝试转换成字符串（末尾h表示16进制，且以两个数字为单位组合，如61表示a, 具体对应关系请查看ascall码表），得到autriVetacollAwZ</p>
<p>由于在内存中，两个数字为一个单位，且右边的单位为高位（比如1234，我们读是一千二百三十四，但是在内存中的顺序来读，则代表三千四百一十二），因此需要将字符串倒过来为ZwAllocateVirtua</p>
<p>结合第29行的lMemory，构成函数ZwAllocateVirtualMemory，用于申请内存。至于为什么能结合，在第14与第15行声明时，v14与ProcName时相邻声明的，因此在内存中其位置也是相邻的，无需再手动进行拼接。</p>
<p>而后通过第30、31行，使procAddress指代函数ZwAllocateVirtualMemory，并于33行调用，将内存分配到v9，内存的大小为v10，v10在第27行赋值为11257i64，很大，因此推测v9并不是用来存储普通变量，而是可能存储数组或者函数，但是这个程序并没有哪一处需要用到这么大的数组（绘制点的存储也不需要这么大），因此推测v9可能用来存储函数。</p>
<p>接下来要盯着v9，分析分配出的内存会被用来做什么。</p>
<p>第44行中，将unk_140005040的数据分配到v9<br><img src="https://i-blog.csdnimg.cn/direct/a9ef1c4d8388475ea61be72f2e65d180.png" alt="请添加图片描述"></p>
<p>但是双击unk_140005040查看其初始值，并不能直接获取到什么有效信息<br><img src="https://i-blog.csdnimg.cn/direct/2241c2e3229c4e0692a72f7ff2a54911.png" alt="请添加图片描述"><br>我们之前推测v9可能用来存储函数，如果真的是这样，那么unk_140005040应该就是那个函数。我们按下c键，IDA将把这些数据转化为汇编码<br><img src="https://i-blog.csdnimg.cn/direct/6a7aeed35f3246738eb5af4ba45cf77f.png" alt="请添加图片描述"></p>
<p>14000504A及之后的代码挺像一回事的，但是前部分作为函数的话缺少几个push，我们就先回到Pseudocode-A，看看之后有没有对函数进行其他处理。</p>
<p>分析代码逻辑，会发现第40行将v9的值赋值给了v6，而第51-53，65-67行，有使用v6来对函数所在内存的开头部分以及其他一些点重新赋值（使用地址定位来进行的小范围赋值一般称为patch）<br><img src="https://i-blog.csdnimg.cn/direct/652f4bfd16964b678c6513f8b37fbd50.png" alt="请添加图片描述"></p>
<p>我们想要查看重新赋值后的函数，就要进入动态分析</p>
<h2 id="动态分析"><a href="#动态分析" class="headerlink" title="动态分析"></a>动态分析</h2><p>点击菜单栏的Debugger，选中Select debugger<br><img src="https://i-blog.csdnimg.cn/direct/c7d81a708bdc4c47b777cbc97a1c157c.png" alt="请添加图片描述"></p>
<p>在弹出的窗口中选择Local Windows debugger，点击OK<br><img src="https://i-blog.csdnimg.cn/direct/7c85121b9f8549dc86eac84feb3a0d89.png" alt="请添加图片描述"></p>
<p>这样我们就设置好了调试器，接下来就是打断点</p>
<p>由于我们希望看到patch后的函数，因此直接在patch后的下一条指令打下断点即可<br><img src="https://i-blog.csdnimg.cn/direct/950216d8fb8146968c1b49fb7c3ac27a.png" alt="请添加图片描述"></p>
<p>再次点击菜单栏的Debugger, 会发现展开内容变化了，选择Start process，即开始调试。弹出的窗口全点yes或ok。<br><img src="https://i-blog.csdnimg.cn/direct/c41a57a608bd4d89ab51e8c0363f93e9.png" alt="请添加图片描述"></p>
<p>代码会停止在下断点处</p>
<p>这时我们就可以查看patch后的代码，查看方式为</p>
<p>鼠标悬浮在v6上，查看v6的值<br><img src="https://i-blog.csdnimg.cn/direct/437df4f645b143d19aa36161f40ecd1b.png" alt="请添加图片描述"></p>
<p>我们就得到了v6的值为0x17DD94E0000（不固定，每一次调试的具体值都可能不同），也就是说0x17DD94E0000指向代码的开始</p>
<p>按下g键，弹出地址跳转窗口，输入v6的值，点击ok。<br><img src="https://i-blog.csdnimg.cn/direct/1e511b8f455f403e97a320afd40fa2c5.png" alt="请添加图片描述"></p>
<p>跳转到新界面后按下c键，将数据转化为汇编代码<br><img src="https://i-blog.csdnimg.cn/direct/9906b5561df74b8f8a7700e41e14f31f.png" alt="请添加图片描述"></p>
<p>可以看到之前的nop都变成具体的代码了。想要看这些汇编代码对于的c语言代码，则右键函数的起始位置，即17DD94E0000 ，在菜单中选择create function<br><img src="https://i-blog.csdnimg.cn/direct/cdb3d11a50e0404e91e389e2c8e81017.png" alt="请添加图片描述"></p>
<p>点击后可以注意到代码再次产生了变化<br><img src="https://i-blog.csdnimg.cn/direct/32a9405b44824bfc96d2c76a75e3b227.png" alt="请添加图片描述"></p>
<p>这时选中函数名，按下tab键，就将跳转到c语言代码界面。<br><img src="https://i-blog.csdnimg.cn/direct/b8526c503dd74681bc7f82e80870aef7.png" alt="请添加图片描述"></p>
<p>这段代码有一些赋值以及看不明白的函数调用，搞不清楚，于是先回到winMain里的那个名为sub_140001090的函数。按下窗口左上角的左向箭头，返回上一个界面<br><img src="https://i-blog.csdnimg.cn/direct/bec6d39c71dd4521b812a8fa4072456c.png" alt="请添加图片描述"></p>
<p>回到sub_140001090，重新梳理程序逻辑，发现第一次调用v6指向的函数为第64行（__fastcall*即意为将之后的内存作为函数调用），会发现这里并不是调用v6的起始位置，而是还有一个1616（十进制，有0x前缀才为16进制）的偏移<br><img src="https://i-blog.csdnimg.cn/direct/fa1a017d42ff48a38f3eabf09fde0f00.png" alt="请添加图片描述"></p>
<p>这意味着v6指向的一大段内存中可能不止一个函数，因此我们再次按下g键，看一看v6偏移1616的函数。1616转为十六进制为0x650，因此函数的地址为：v6+650，以我这次运行的v6&#x3D;0x17DD94E0000，加上0x650的偏移，就是 0x17DD94E0650。</p>
<p>按下g键，输入地址，按下c键，转化为汇编码，右键函数起始，create function，选中函数名，按下tab，以操作0x17DD94E0000的步骤，操作0x17DD94E0650，查看其c语言代码<br><img src="https://i-blog.csdnimg.cn/direct/f8927424e0924d3c9eec92976ea440e0.png" alt="请添加图片描述"></p>
<p>结果还是莫名其妙的赋值以及函数调用</p>
<p>但在第111行的字符串中，看到了position，有看到了color，由此推测图像绘制的核心代码大概就存在于v6指向的那一大块代码里。<br><img src="https://i-blog.csdnimg.cn/direct/9fa57b2606764a00a7f4caee64e8fe99.png" alt="请添加图片描述"></p>
<p>由于sub_140001090中只有一处有调用v6内存中的函数——v6+650，因此对绘制图像的处理大概率存在于v6+650或是从v6+650中跳转。具体逻辑分析起来太过于繁杂，我们先看深蓝色的变量</p>
<p>前几个是对变量进行操作，由于操作的变量意义不明，因此这几步也看不出来什么<br><img src="https://i-blog.csdnimg.cn/direct/a0f470afbd324ddebc15189f661a2053.png" alt="请添加图片描述"></p>
<p>但在第249行可以注意到有调用一个函数，且地址为v6+0x420（函数默认名称去除前缀就是函数地址），这意味着v6+0x420处也存在一个函数，并且会在v6+0x650中进行调用。<br><img src="https://i-blog.csdnimg.cn/direct/63a788eeb43f48359aa742bfc76eb4e5.png" alt="请添加图片描述"></p>
<p>那我们就再看一看v6+0x420处的代码：按下g键，输入地址，按下c键，转化成汇编码，右键首行,create function；选中函数名，按下tab键查看c代码<br><img src="https://i-blog.csdnimg.cn/direct/6234ad357e3545349ba540f88bae02be.png" alt="请添加图片描述"></p>
<p>终于是一段能看明白结构的while + switch代码，这种结构被其他博主称作虚拟机结构。</p>
<p>看一下各个case，0,1,2,3,4都是做了些意义不明的运算，5,6调用了同一个函数，函数地址是v6+0，且只有第五个参数不同。为了之后遇到的时候更好辨认这个函数，我们给v6+0起一个名字。</p>
<p>右键单击函数，在菜单中选择Rename global item<br><img src="https://i-blog.csdnimg.cn/direct/1d4a43710a73448fab25fe7811c5f76d.png" alt="请添加图片描述"></p>
<p>我将其命名为shellCode0，点击ok。其他的可以同理命名为shellCode420，shellCode650。<br><img src="https://i-blog.csdnimg.cn/direct/abae6d122412433fa7f1f0d004a80fb4.png" alt="请添加图片描述"></p>
<p>重命名后，函数就好辨认多了<br><img src="https://i-blog.csdnimg.cn/direct/c051be0bff6f46caae861e08cb1198d6.png" alt="请添加图片描述"><br>shellCode0里只有第五个参数不同，因此想研究一下第五个参数的意义</p>
<p>鼠标悬浮在第五个参数时，会显示invsign，通过询问ai，得知invsign是倒数的意思，因此先把他从倒数转化会普通值（我这里莫名奇妙突然显示起了函数以及参数的类型，我也不太清楚是按到了哪个键，不过不影响之后的过程）<br><img src="https://i-blog.csdnimg.cn/direct/87ca6ee5ad0d4ade92db23055e9ae161.png" alt="请添加图片描述"></p>
<p>右键-256，在菜单中选择Hexadecimal，将其为普通值，同理转化case6的13771801<br><img src="https://i-blog.csdnimg.cn/direct/0d88b543190a4e49bbcceabb12115c0d.png" alt="请添加图片描述"></p>
<p>分别得到0xFFFFFF00，以及0xFF0DDBE7<br><img src="https://i-blog.csdnimg.cn/direct/7d5c3c6cea3c4740a2feeca0d92617bb.png" alt="请添加图片描述"></p>
<p>很像是16进制的颜色代码，因此在取色表看一下，发现真的是题目绘制需要的两种颜色，前置的两个ff应该是占位。既然shellcode0需要用到颜色，因此推测shellcode0即为绘制代码。<br><img src="https://i-blog.csdnimg.cn/direct/de51a7739a3648438e19e2fa0e336942.png" alt="请添加图片描述"></p>
<p>但shecode0我们只知道第五个参数的含义（颜色），其他参数连具体值都不知道，因此我们尝试获取每一次调取shellcode0时的各个参数。</p>
<h2 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h2><p>我们将使用hook技术获取到每一次调取shellcode0时的十个参数。</p>
<p>hook技术分为几种，这里使用inline hook，我学习inline hook技术的文章有：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/459912527">InlineHook &amp; 原理与实现 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/northeast-coder/p/15782665.html">万字长文！inlinehook看这一篇足矣！ - 东北码农 - 博客园 (cnblogs.com)</a></p>
<p>hook的细节请查看这两篇文章学习，这里只是结合赛题简单讲一讲hook</p>
<p>简单来说hook就是将函数的开头代码修改为一段跳转代码，跳转到一个自定义的函数。比如我们现在想要获取到每一次调取shellcode0时的十个参数，就将函数的开头修改为跳转到一个自定义的print函数，将参数全部打印输出。</p>
<p>hook一般需要两个东西，一个是自己编写的dll文件，用于实现修改函数开头，以及实现自定义函数；还有一个被称为注入器，用于将dll文件注入到进程中。</p>
<p>首先是注入器的代码，思路就是查看是否有名为”2022游戏安全技术竞赛初赛.exe”的进程，如果有，则使用windows提供的api注入最后一句代码路径中的dll文件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入器代码</span></span><br><span class="line">#include&lt;windows.<span class="property">h</span>&gt;</span><br><span class="line">#include&lt;iostream&gt;</span><br><span class="line">#include&lt;time.<span class="property">h</span>&gt;</span><br><span class="line">#include&lt;stdlib.<span class="property">h</span>&gt;</span><br><span class="line">#include&lt;<span class="title class_">TlHelp32</span>.<span class="property">h</span>&gt;</span><br><span class="line">#define <span class="variable constant_">EXEFILEW</span> L<span class="string">&quot;2022游戏安全技术竞赛初赛.exe&quot;</span></span><br><span class="line">#define <span class="variable constant_">EXEFILE</span> <span class="string">&quot;2022游戏安全技术竞赛初赛.exe&quot;</span></span><br><span class="line"><span class="variable constant_">DWORD</span> old;</span><br><span class="line"><span class="variable constant_">SIZE_T</span> written;</span><br><span class="line"><span class="variable constant_">DWORD</span> <span class="title class_">FindProcess</span>() &#123;</span><br><span class="line">    <span class="variable constant_">HANDLE</span> hSnap = <span class="title class_">CreateToolhelp32Snapshot</span>(<span class="title class_">TH32CS</span>_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="title class_">PROCESSENTRY32</span> pe32;</span><br><span class="line">    pe32 = &#123; <span class="title function_">sizeof</span>(pe32) &#125;;</span><br><span class="line">    <span class="variable constant_">BOOL</span> ret = <span class="title class_">Process32First</span>(hSnap, &amp;pe32);</span><br><span class="line">    <span class="keyword">while</span> (ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">wcsncmp</span>(pe32.<span class="property">szExeFile</span>, <span class="variable constant_">EXEFILEW</span>, <span class="title function_">lstrlen</span>(<span class="variable constant_">EXEFILEW</span>))) &#123;</span><br><span class="line">            <span class="title function_">printf</span>(<span class="string">&quot;找到程序 %s ,PID=%d\n&quot;</span>, <span class="variable constant_">EXEFILE</span>, pe32.<span class="property">th32ProcessID</span>);</span><br><span class="line">            <span class="keyword">return</span> pe32.<span class="property">th32ProcessID</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = <span class="title class_">Process32Next</span>(hSnap, &amp;pe32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title class_">InjectModule</span>(<span class="variable constant_">DWORD</span> <span class="title class_">ProcessId</span>, <span class="keyword">const</span> char* szPath)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable constant_">HANDLE</span> hProcess = <span class="title class_">OpenProcess</span>(<span class="variable constant_">PROCESS_ALL_ACCESS</span>, <span class="variable constant_">FALSE</span>, <span class="title class_">ProcessId</span>);</span><br><span class="line">    <span class="title function_">printf</span>(<span class="string">&quot;进程句柄:%p\n&quot;</span>, hProcess);</span><br><span class="line">    <span class="variable constant_">LPVOID</span> lpAddress = <span class="title class_">VirtualAllocEx</span>(hProcess, <span class="variable constant_">NULL</span>, <span class="number">0x100</span>, <span class="variable constant_">MEM_COMMIT</span> | <span class="variable constant_">MEM_RESERVE</span>, <span class="variable constant_">PAGE_READWRITE</span>);</span><br><span class="line">    <span class="variable constant_">SIZE_T</span> dwWriteLength = <span class="number">0</span>;</span><br><span class="line">    <span class="title class_">WriteProcessMemory</span>(hProcess, lpAddress, szPath, <span class="title function_">strlen</span>(szPath), &amp;dwWriteLength);</span><br><span class="line">    <span class="variable constant_">HANDLE</span> hThread = <span class="title class_">CreateRemoteThread</span>(hProcess, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>, (<span class="variable constant_">LPTHREAD_START_ROUTINE</span>)<span class="title class_">LoadLibraryA</span>, lpAddress, <span class="variable constant_">NULL</span>, <span class="variable constant_">NULL</span>);</span><br><span class="line">    <span class="title class_">WaitForSingleObject</span>(hThread, -<span class="number">1</span>);</span><br><span class="line">    <span class="title class_">VirtualFreeEx</span>(hProcess, lpAddress, <span class="number">0</span>, <span class="variable constant_">MEM_RELEASE</span>);</span><br><span class="line">    <span class="title class_">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="title class_">CloseHandle</span>(hThread);</span><br><span class="line">&#125;</span><br><span class="line">int <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable constant_">DWORD</span> <span class="title class_">ProcessId</span> = <span class="title class_">FindProcess</span>();</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title class_">ProcessId</span>) &#123;</span><br><span class="line">        <span class="title function_">printf</span>(<span class="string">&quot;未找到%s程序，等待两秒中再试\n&quot;</span>, <span class="variable constant_">EXEFILE</span>);</span><br><span class="line">        <span class="title class_">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line">        <span class="title class_">ProcessId</span> = <span class="title class_">FindProcess</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">InjectModule</span>(<span class="title class_">ProcessId</span>, <span class="string">&quot;C:\\ZencyData\\CODE\\C_plus_plus\\injectionDll\\x64\\Debug\\injectionDll.dll&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是 dll文件，首先打开visual studio，创建一个dll新项目</p>
<p><img src="https://i-blog.csdnimg.cn/direct/e671a1643fac43c189374578aab4e52e.png" alt="请添加图片描述"></p>
<p>将新项目的dllmain.cpp文件中的代码修改为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> __int64 (*Func)(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5, __int64 a6, __int64 a7, __int64 a8, __int64 a9, __int64 a10);</span><br><span class="line"><span class="function">__int64 <span class="title">GetBaseAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HMODULE hMode = <span class="built_in">GetModuleHandle</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span> (__int64)hMode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span>* shellcode = <span class="number">0</span>;</span><br><span class="line">BYTE HookCode[] = &#123; <span class="comment">//目标将开头修改成HookCode</span></span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,  <span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>                                           <span class="comment">//jmp rax </span></span><br><span class="line">&#125;;</span><br><span class="line">BYTE OriginCode[<span class="number">0x50</span>]; <span class="comment">//存储修改前的开头</span></span><br><span class="line"><span class="type">size_t</span> HookLen = <span class="number">12</span>;  <span class="comment">// 修改内存大小为100</span></span><br><span class="line">__int64 times = <span class="number">100</span>;  <span class="comment">//只输出100次hook结果</span></span><br><span class="line"><span class="function">__int64 <span class="title">HackShellcode</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5, __int64 a6, __int64 a7, __int64 a8, __int64 a9, __int64 a10)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(shellcode, OriginCode,HookLen);              <span class="comment">//将开头恢复成原来的样子</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> x = a1, y = a2;</span><br><span class="line">    __int64 ret=(*(Func)shellcode)(x, y, a3, a4, a5, a6, a7, a8, a9, a10); <span class="comment">//</span></span><br><span class="line">    times--;</span><br><span class="line">    <span class="keyword">if</span> (times&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;call shellcode(%d,%d,%d,%d,%d,%p,%p,%p,%p,%p)\n&quot;</span>,x, y, a3, a4, a5, a6, a7, a8, a9, a10);          </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(shellcode, HookCode, HookLen);               <span class="comment">//将开头修改为跳转到自定义函数</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HookShellcode</span><span class="params">()</span> </span>&#123; <span class="comment">// 第一次hook代码</span></span><br><span class="line">    __int64 base = <span class="built_in">GetBaseAddr</span>(); <span class="comment">//程序基地址</span></span><br><span class="line">    __int64 Ptr = base + <span class="number">0x8308</span>; <span class="comment">//指针的地址为程序地址 + 0x8308</span></span><br><span class="line"></span><br><span class="line">    shellcode = (<span class="type">void</span>*)(*(__int64*)Ptr); <span class="comment">//获取shellcode0代码起始地址</span></span><br><span class="line">    <span class="keyword">while</span> (!shellcode) &#123; <span class="comment">//上一步获取失败，间隔0.2秒后再次尝试</span></span><br><span class="line">        shellcode = (<span class="type">void</span>*)(*(__int64*)Ptr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Find shellcode Fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;shellcode addr=%p\n&quot;</span>, shellcode); <span class="comment">//输出shellcode0代码起始地址</span></span><br><span class="line">    <span class="built_in">memcpy</span>(OriginCode, shellcode,HookLen);              <span class="comment">//存储原本起始地址</span></span><br><span class="line">    Func FuncPtr = HackShellcode;                <span class="comment">//获取自定义函数地址</span></span><br><span class="line">    *(__int64*)(HookCode + <span class="number">2</span>) = (__int64)FuncPtr;    <span class="comment">//将HookCode跳转到的地址改为自定义函数地址</span></span><br><span class="line">    <span class="built_in">memcpy</span>(shellcode, HookCode, HookLen);               <span class="comment">//将原本函数开头修改为跳转指令</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                      DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                      LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//dll文件的main函数</span></span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH:<span class="comment">//dll文件被注入时调用</span></span><br><span class="line">            <span class="built_in">AllocConsole</span>();<span class="comment">//启动一个控制台</span></span><br><span class="line">            <span class="built_in">freopen</span>(<span class="string">&quot;CONOUT$&quot;</span>, <span class="string">&quot;w&quot;</span>, stdout);<span class="comment">//设置输出</span></span><br><span class="line">            <span class="built_in">HookShellcode</span>();<span class="comment">//进行第一次hook</span></span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个dll文件的逻辑也比较清晰，就是将shellcode0的开头修改成一个跳转指令，跳转到HackShellcode函数；然后在HackShellcode中print输出参数，并且将开头恢复为修改前的状态，重新调用一次shellcode0，完成shellcode0原本需要完成的功能；调用完成后，再将开头修改为跳转，以输出shellcode0的下一次调用。</p>
<p>这里主要解释HookShellcode函数第二行的0x8308是怎么来的。</p>
<p>hook时，我们需要知道函数的地址。在我们重命名前，shellcode0我们称为v6+0，因为它的地址是v6偏移量为0的地址。所以我们需要去看v6的值。</p>
<p>按下窗口左上角 左向箭头旁边的扩展力，点击倒数第三个选项（具体名称大概不一样，但是地址以1090结尾），我们就能跳转回v6出现的那个界面<br><img src="https://i-blog.csdnimg.cn/direct/e06339bfe7c84d4dbaa3aeed78274678.png" alt="请添加图片描述"></p>
<p>我们发现，在给v6赋值的时候，还将v9的值赋值给了一个全局变量qword_7FF60D008308，这意味着qword_7FF60D008308的值即为v6，即v9，也即shellcode0的地址，而qword_7FF60D008308的地址为0x7FF60D008308，根据右边第二个窗口中可以看到，此程序的基地址为0x7FF6D000000（不一定一样，甚至每次调试都可能变化），也就是qword_7FF60D008308的地址为基地址+0x8308，因此在dll文件中，通过基地址+8308可以获取到qword_7FF60D008308的值，然后这个值就是shellcode的地址。<br><img src="https://i-blog.csdnimg.cn/direct/c5f7d4eb04c64e988496cad8251cf84f.png" alt="请添加图片描述"></p>
<p>接下来我们就生成dll文件。</p>
<p>生成之前，还需要加在pch.cpp中增加一句宏定义代码，取消visual studio的默认安全模式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://i-blog.csdnimg.cn/direct/86d7c8514c61419d81b501eceb15e7d4.png" alt="请添加图片描述"></p>
<p>鼠标右击项目名，菜单中点击“生成”<br><img src="https://i-blog.csdnimg.cn/direct/a7ea8dae3b9842e296b1ef0b4ee0e210.png" alt="请添加图片描述"></p>
<p>dll文件就生成了，生成路径就在窗口底部的输出中。<br><img src="https://i-blog.csdnimg.cn/direct/b510290e21964140989eabd43a1f7814.png" alt="请添加图片描述"></p>
<p>接下来准备运行注入器，vs新建一个控制台项目，并将主文件的代码修改为之前给出的注入器代码（要修改末尾的dll文件路径）。</p>
<p>运行注入器代码（请确定此时ida pro还在调试），弹出命令行窗口显示找到句柄后，再点击 ida pro这个运行按钮，跳过打下的断点。<br><img src="https://i-blog.csdnimg.cn/direct/530bf6aa8f934d20baa8b5d5b95841ab.png" alt="请添加图片描述"><br>在弹出的窗口中可以看到100次调用shellcode0时使用的参数，并且可以看到箭头指向的两个地方参数是开始重复的。也就是说绘图不只调用一次。<br><img src="https://i-blog.csdnimg.cn/direct/83147a0612e74fe58662b7fab4dc7127.png" alt="请添加图片描述"></p>
<p>但是注意到赛题程序界面是一片白<br><img src="https://i-blog.csdnimg.cn/direct/ef4b52520fe34cb2a6ef1408b063ceef.png" alt="请添加图片描述"></p>
<p>不知道是不是hook出问题了，于是不调试，直接在文件夹中打开赛题程序，然后发现程序是显示绘制的图像大概4秒，就会清空，然后显示一片白，由此看出不是hook的问题，大概只是4秒过了。</p>
<p>通过hook的结果可以看到，参数不重复的调用一共有42次，而赛题目标的图案中正好有42个点，且第五个参数为-256的有11个点，为-13771801的有31个点，与赛题目标黄蓝点的数量也相同，由此更加确认shellcode就是绘制图像的函数。</p>
<p>然后观察参数，我们已知第五个是颜色，后五个参数每次调用都相同，那应该就是前4个参数控制位置。前两个参数的格式像是x,y坐标，于是尝试将其视为坐标进行绘制，由于蓝色图案的显示是正常的，因此尝试将x,y理解为坐标，绘制蓝色图案<br><img src="https://i-blog.csdnimg.cn/direct/5fb74ce882c648fdb30de0b2e6ca2c08.png" alt="请添加图片描述"><br>发现是赛题中给出图案的上下翻转。由此确定前两个参数确实为坐标，而黄色图案的前两个参数中存在负数，可能这就是无法显示的原因，具体分析请见下期教程</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Zency</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/post/pojie/2022tencentFlag1/">http://example.com/post/pojie/2022tencentFlag1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">☀️ SunnyCandy's blog 🍬</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91/">逆向</a></div><div class="post_share"><div class="social-share" data-image="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/4ba515845bfc27a4c7811ededcbf49cd4d372054d1544d00efb3bf9d1c754b95129e7006549fdcd6ba5ef07b3abb2ea4?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;fname=20.png&amp;size=750" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/pojie/mutilWechat/" title="逆向微信-实现微信多开"><img class="cover" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/ef13bd09fbadbe819ea9f06c4bf2d852c8ef5bc653bfd009f1f5e4e80a4f33c6dcaff217a9e67a029a16c589a3207378?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;fname=back19.jpg&amp;size=750" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">逆向微信-实现微信多开</div></div></a></div><div class="next-post pull-right"><a href="/post/pojie/2022tencentFlag2/" title="小白向—2022腾讯游戏安全初赛分析（下）"><img class="cover" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/ee2a6e233014bcca2568388bf989be471dfad30558e122c71777a3cc5066fb81a078ffd951f5bb5039d7ccf53864558e?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;fname=back21.png&amp;size=750" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">小白向—2022腾讯游戏安全初赛分析（下）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/pojie/mutilWechat/" title="逆向微信-实现微信多开"><img class="cover" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/ef13bd09fbadbe819ea9f06c4bf2d852c8ef5bc653bfd009f1f5e4e80a4f33c6dcaff217a9e67a029a16c589a3207378?pictype=scale&from=30013&version=3.3.3.3&fname=back19.jpg&size=750" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-09</div><div class="title">逆向微信-实现微信多开</div></div></a></div><div><a href="/post/pojie/2022tencentFlag2/" title="小白向—2022腾讯游戏安全初赛分析（下）"><img class="cover" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/ee2a6e233014bcca2568388bf989be471dfad30558e122c71777a3cc5066fb81a078ffd951f5bb5039d7ccf53864558e?pictype=scale&from=30013&version=3.3.3.3&fname=back21.png&size=750" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-29</div><div class="title">小白向—2022腾讯游戏安全初赛分析（下）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">参考：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%8F%E7%99%BD%E5%B0%86%E5%AD%A6%E5%88%B0"><span class="toc-number">3.</span> <span class="toc-text">小白将学到</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%80%E9%9C%80%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">4.</span> <span class="toc-text">所需前置知识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%80%E9%9C%80%E5%B7%A5%E5%85%B7"><span class="toc-number">5.</span> <span class="toc-text">所需工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%9B%E9%A2%98%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">赛题说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">操作与分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IDA-Pro%E6%89%93%E5%BC%80%E8%B5%9B%E9%A2%98%E7%9A%84exe%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.1.</span> <span class="toc-text">使用IDA Pro打开赛题的exe程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">7.2.</span> <span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">7.3.</span> <span class="toc-text">动态分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hook"><span class="toc-number">7.4.</span> <span class="toc-text">hook</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Zency</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">在看吗？在看的话mua你一下 ♥</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="iconfont icon-augmented-reality"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="iconfont icon-zhouyejiaoti"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="iconfont icon-augmented-reality"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="iconfont icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="iconfont icon-gear"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="iconfont icon-up-arrow"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="iconfont icon-yellow-team"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/asset/js/cursor.js"></script><script defer src="/asset/js/universe.js"></script><script defer src="/asset/js/console.js"></script><script async src="/asset/js/fps.js"></script><script async src="/asset/js/title.js"></script><script async src="/asset/js/click-heart.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>